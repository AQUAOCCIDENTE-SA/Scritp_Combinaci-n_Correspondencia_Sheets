const ID_plantilla_docs = "1f0GEZrOURBTUReOm6y6s-2IDzFxotQYRnBSx4ddVLT4"
const ID_Documentos = "17KRy_JwmCK4y3xysPo_8FjTyRQPPPqKW" // mismo id de PDF
const ID_CARPETA_PDFS = "17KRy_JwmCK4y3xysPo_8FjTyRQPPPqKW"
var libro = SpreadsheetApp.getActiveSpreadsheet();
var hojaClientes = libro.getSheetByName("1 S y 2F (3A)")
var sheet = SpreadsheetApp.getActiveSheet();
var startFila = 2;

const colConsecutivo = 1;
const colNombre_Cliente = 2;
const colCodigo = 3;
const colRuta = 4;
const colDireccion = 5;
const colFecha_Comunicado = 6;
const colFecha_Rev = 7;
const colMes_Fac = 8;
const colMes_Fac1 = 9;
const colMes_Fac2 = 10;
const colFac_Anulada = 11;
const colValor_V = 12;
const colFac_New = 13;
const colValor_N = 14;
const colValor_Cuota = 15;
const colFac_Anulada1 = 16;
const colValor_V1 = 17;
const colFac_Anulada2 = 18;
const colValor_V2 = 19;
const colPeriodo1 = 20;
const colFac_New1 = 21;
const colValor_N1 = 22;
const colPeriodo2 = 23;
const colFac_New2 = 24;
const colValor_N2 = 25;
const colEnviado = 26;
const colFecha_envio = 27;

function onOpen() {
  var ui = SpreadsheetApp.getUi();
  ui.createMenu("Combinar 1 S y 2F (3A)")
    .addItem("Combinar Correspondencia", "combinarCorrespondencia")
    .addToUi();
}

function combinarCorrespondencia() {
  var ui = SpreadsheetApp.getUi();
  var respuesta = ui.alert("Quieres generar los ducumentos, pulsa si para continuar", ui.ButtonSet.YES_NO);

  if (respuesta == ui.Button.YES) {
    var clientes = hojaClientes.getDataRange().getValues();
    clientes.shift()
    for (i = 0; i < clientes.length; i++) {
      envioIndividual(i + 2)
    }

    function envioIndividual(fila) {
      //Traemos variables de sheets
      var consecutivo = hojaClientes.getRange(fila, colConsecutivo).getValue()
      var nombre_cliente = hojaClientes.getRange(fila, colNombre_Cliente).getValue()
      var codigo = hojaClientes.getRange(fila, colCodigo).getValue()
      var ruta = hojaClientes.getRange(fila, colRuta).getValue()
      var direccion = hojaClientes.getRange(fila, colDireccion).getValue()
      var fecha_comunicado = hojaClientes.getRange(fila, colFecha_Comunicado).getValue()
      var fecha_rev = hojaClientes.getRange(fila, colFecha_Rev).getValue()
      var mes_fac = hojaClientes.getRange(fila, colMes_Fac).getValue()
      var mes_fac1 = hojaClientes.getRange(fila, colMes_Fac1).getValue()
      var mes_fac2 = hojaClientes.getRange(fila, colMes_Fac2).getValue()
      var fac_anulada = hojaClientes.getRange(fila, colFac_Anulada).getValue()
      var valor_v = hojaClientes.getRange(fila, colValor_V).getValue()
      var fac_new = hojaClientes.getRange(fila, colFac_New).getValue()
      var valor_n = hojaClientes.getRange(fila, colValor_N).getValue()
      var valor_cuota = hojaClientes.getRange(fila, colValor_Cuota).getValue()
      var fac_anulada1 = hojaClientes.getRange(fila, colFac_Anulada1).getValue()
      var valor_v1 = hojaClientes.getRange(fila, colValor_V1).getValue()
      var fac_anulada2 = hojaClientes.getRange(fila, colFac_Anulada2).getValue()
      var valor_v2 = hojaClientes.getRange(fila, colValor_V2).getValue()      
      var periodo1 = hojaClientes.getRange(fila, colPeriodo1).getValue()
      var fac_new1 = hojaClientes.getRange(fila, colFac_New1).getValue()
      var valor_n1 = hojaClientes.getRange(fila, colValor_N1).getValue()
      var periodo2 = hojaClientes.getRange(fila, colPeriodo2).getValue()
      var fac_new2 = hojaClientes.getRange(fila, colFac_New2).getValue()
      var valor_n2 = hojaClientes.getRange(fila, colValor_N2).getValue()
      var fechaEnvio = hojaClientes.getRange(fila, colEnviado).getValue()
      
      //fecha_rev = Utilities.formatDate(fecha_rev, Session.getScriptTimeZone(), "d/M/yyyy");
     
          
      //Formatear valor en formato de moneda
      var valor_v_formateado = valor_v.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
      var valor_n_formateado = valor_n.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
      var valor_n1_formateado = valor_n1.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
      var valor_n2_formateado = valor_n2.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
      var valor_cuota_formateado = valor_cuota.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
      var valor_v1_formateado = valor_v1.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
      var valor_v2_formateado = valor_v2.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });

    
      if (fechaEnvio == "") {

        //Crear copia de la plantilla y reemplazar variables
        var archivoDocs = DriveApp.getFileById(ID_plantilla_docs).makeCopy(codigo, DriveApp.getFolderById(ID_Documentos));
        var doc = DocumentApp.openById(archivoDocs.getId())
        doc.getBody().replaceText("<<consecutivo>>", consecutivo)
        doc.getBody().replaceText("<<nombre_cliente>>", nombre_cliente)
        doc.getBody().replaceText("<<codigo>>", codigo)
        doc.getBody().replaceText("<<ruta>>", ruta)
        doc.getBody().replaceText("<<direccion>>", direccion)
        doc.getBody().replaceText("<<fecha_comunicado>>", fecha_comunicado)
        doc.getBody().replaceText("<<fecha_rev>>", fecha_rev)
        doc.getBody().replaceText("<<mes_fac>>", mes_fac)
        doc.getBody().replaceText("<<mes_fac1>>", mes_fac1)
        doc.getBody().replaceText("<<mes_fac2>>", mes_fac2)
        doc.getBody().replaceText("<<fac_anulada>>", fac_anulada)
        doc.getBody().replaceText("<<valor_v>>", valor_v_formateado)
        doc.getBody().replaceText("<<fac_new>>", fac_new)
        doc.getBody().replaceText("<<valor_n>>", valor_n_formateado)
        doc.getBody().replaceText("<<valor_cuota>>", valor_cuota_formateado)
        doc.getBody().replaceText("<<fac_anulada1>>", fac_anulada1)
        doc.getBody().replaceText("<<valor_v1>>", valor_v1_formateado)
        doc.getBody().replaceText("<<fac_anulada2>>", fac_anulada2)
        doc.getBody().replaceText("<<valor_v2>>", valor_v2_formateado)
        doc.getBody().replaceText("<<periodo1>>", periodo1)
        doc.getBody().replaceText("<<fac_new1>>", fac_new1)
        doc.getBody().replaceText("<<valor_n1>>", valor_n1_formateado)
        doc.getBody().replaceText("<<periodo2>>", periodo2)
        doc.getBody().replaceText("<<fac_new2>>", fac_new2)
        doc.getBody().replaceText("<<valor_n2>>", valor_n2_formateado)      
        doc.saveAndClose();

        //Crea y envia el pdf
        var pdf1 = archivoDocs.getBlob()
        var carpetaPDFS = DriveApp.getFolderById(ID_CARPETA_PDFS)
        //Envía el correo electrónico con los archivos adjuntos
        /*enviarPDFMail(mail, nombre, archivosAdjuntos);*/

        carpetaPDFS.createFile(pdf1)//crea el archivo en el drive
        archivoDocs.setTrashed(true)//borra el archivo documentos

        //registro de envio y creacio de envio
        hojaClientes.getRange(fila, colEnviado).setValue(new Date())

        // Agrega el checkbox
        sheet.getRange(startFila + i, colEnviado).insertCheckboxes();

        // Marca el checkbox
        sheet.getRange(startFila + i, colEnviado).setValue(true);

        // Agrega la fecha de envío  
        var timeZone = "America/Bogota"; // Obtener la zona horaria del script
        var date = new Date().toLocaleString("es-CO", { timeZone: timeZone }); // Obtener la fecha actual en la zona horaria del script
        sheet.getRange(startFila + i, colFecha_envio).setValue(date); // Asignar la fecha a la celda


      }
    }

    ui.alert("Documentos generados correctamente");

  } else {
    ui.alert("Operación cancelada");

  }
}
